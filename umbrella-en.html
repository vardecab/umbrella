<!doctype html>
<html lang="en">

<head>

    <title>Umbrella</title>
    <meta property="og:title" content="Umbrella">
    <meta name="description" content="A simple weather page that tells you if you need to take an umbrella when going outside.">
    <meta property="og:description" content="A simple weather page that tells you if you need to take an umbrella when going outside.">
    <meta property="og:image" content="https://vardecab.github.io/umbrella/images/social-sharing/umbrella-facebook-ogimage-v2.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:url" content="https://vardecab.github.io/umbrella/umbrella-en.html">
    <meta name="twitter:card" content="summary_large_image">
    
    <meta name="theme-color" content="#000000"> <!-- default -->

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="icon" type="image/png" href="./images/umbrella-icon_blue-circle.png" />

    <link rel="stylesheet" href="./styles/styles.css" />

    <script src="./scripts/weather-en.js"></script>
    <script src="./scripts/air_quality-en.js"></script>
    <!-- <script src="./scripts/allergy.js"></script> NOTE: API doesn't have good coverage -->

    <script src="./scripts/libraries/moment.min.js"></script> <!-- time formats manipulation -->
    <script src="./scripts/libraries/js.cookie.min.js"></script> <!-- lightweight JavaScript API for handling browser cookies -->

</head>

<body>
    <div class="container">
        <div class="row">
            <div class="twelve columns">

                <img id="icon" src="./images/status/loading.svg">

                <div id="temperature" title="Average temperature in the next ~ 6 hours."></div>

                <div id="more_details">
                    <span id="sunrise" title="Sunrise:">‚òÄÔ∏è </span>
                    <span id="wind" title="Wind speed:">üçÉ </span>
                    <span id="sunset" title="Sunset:">üåí </span>
                </div>

                <div id="loading">Looking at the clouds... üßê</div>

                <div id="umbrella" title="Rain?"></div>
                <div id="clothes" title="What should I wear? ü§î"></div>
                <div id="air_quality" title="ü§ì Good; ü§¢ Bad; ü§¨ Terrible; ‚ö∞Ô∏è RIP"></div>

            </div>
        </div>
    </div>

    <div id="bottom_navbar">
        <div id="to_the_right">
            <p id="findme"
            onclick="Cookies.remove('umbrella_coord_lat'); Cookies.remove('umbrella_coord_lng'); Cookies.remove('umbrella_location');"
            title="Find me!">üìç</p>
            <p id="location"
            onclick="Cookies.remove('umbrella_coord_lat'); Cookies.remove('umbrella_coord_lng'); Cookies.remove('umbrella_location');"
            title="Change the location.">üåç</p>
        </div>
        <div id="to_the_left">
            <p onclick="window.location='umbrella.html'" title="Zmie≈Ñ wersjƒô jƒôzykowƒÖ na polskƒÖ.">üáµüá±</p>
        </div>  
    </div>

    <script>
        window.onload = function geoLocator() {

            if ((Cookies.get("umbrella_coord_lat") == undefined) || (Cookies.get("umbrella_coord_lng") ==
                    undefined)) {

                // get coords from geolocation (GPS/IP)
                function success(position) {
                    const geo_latitude = position.coords.latitude;
                    const geo_longitude = position.coords.longitude;

                    // set üç™ for latitude
                    Cookies.set("umbrella_coord_lat", geo_latitude, {
                        expires: 30,
                        path: "/"
                    })
                    // set üç™ for longitude
                    Cookies.set("umbrella_coord_lng", geo_longitude, {
                        expires: 30,
                        path: "/"
                    })
                    console.log("Cookie data: " + "lat:" + Cookies.get("umbrella_coord_lat") + " lng:" +
                        Cookies.get(
                            "umbrella_coord_lng")); // debug

                    // variables with values from üç™s
                    cookie_lng = Cookies.get("umbrella_coord_lng");
                    cookie_lat = Cookies.get("umbrella_coord_lat");

                    // API key which we use in the next piece
                    const liq_api_key = "a95509ae99d0ab"; // well... no way to hide it ¬Ø\_(„ÉÑ)_/¬Ø

                    // we need to get city name from LocationIQ API
                    fetch("https://eu1.locationiq.com/v1/reverse.php?key=" + liq_api_key + "&lat=" + cookie_lat +
                            "&lon=" + cookie_lng +
                            "&format=json")

                        // convert data to JSON
                        .then(function (res) {
                            return res.json();
                        })

                        // use the data stored in object to do whatever
                        .then(function (liq_data) {
                            console.error("LocationIQ",
                                liq_data); // debug: output everything stored in the object

                            // get city name
                            // liq_location = liq_data.address.city;
                            // liq_location = liq_data[0].display_name.split(",")[0];
                            if ((liq_data.address.town = "null") || (liq_data.address.town = "undefined") || (
                                    liq_data.address.town = "")) { 
                                if ((liq_data.address.city = "null") || (liq_data.address.city = "undefined") ||
                                    (liq_data.address.city = "")) {
                                    liq_location = liq_data.address.county;
                                } else {
                                    liq_location = liq_data.address.city;
                                }
                            }
                            
                            // show city name on the website
                            document.getElementById("location").textContent = "üåç " + liq_location;

                            // set üç™ for location name so we can reuse in future without querying API
                            Cookies.set("umbrella_location", liq_location, {
                                expires: 30,
                                path: "/"
                            })
                        })

                    weatherBallon(cookie_lat, cookie_lng); // pass coords to get weather info
                    airMask(cookie_lat, cookie_lng); // pass coords to get air quality info
                    // apsik(cookie_lat, cookie_lng); // pass coords to get allergy info; NOTE: API doesn't have good coverage
                }

                function error() {
                    alert(
                        "It looks like I can't find your location... You probably have GPS turned off :(");
                    // if we don't know the location let's ask the user
                    query_input = prompt(
                        "Where would you like to check the weather?"
                    ); 
                    console.log("User-requested city:", query_input); // debug

                    const liq_api_key = "a95509ae99d0ab"; // well... no way to hide it ¬Ø\_(„ÉÑ)_/¬Ø

                    // grab data from URL
                    fetch("https://eu1.locationiq.com/v1/search.php?key=" + liq_api_key + "&q=" + query_input +
                            "&format=json")

                        // convert data to JSON
                        .then(function (res) {
                            return res.json();
                        })

                        // use the data stored in object to do whatever
                        .then(function (liq_data) {
                            console.error("LocationIQ",
                                liq_data); // debug: output everything stored in the object

                            // get location name based on what was returned from API and cut it to just city
                            liq_location = liq_data[0].display_name.split(",")[0];
                            // console.error(liq_location); // debug

                            document.getElementById("location").textContent = "üåç " + liq_location;

                            // set üç™ for location name
                            Cookies.set("umbrella_location", liq_location, {
                                expires: 30,
                                path: "/"
                            })

                            // get coords from API based on location user inputted 
                            lat = liq_data[0].lat;
                            lng = liq_data[0].lon;
                            console.log("Coords: " + lat + ", " + lng); // debug

                            // set üç™ for latitude
                            Cookies.set("umbrella_coord_lat", lat, {
                                expires: 30,
                                path: "/"
                            })
                            // set üç™ for longitude
                            Cookies.set("umbrella_coord_lng", lng, {
                                expires: 30,
                                path: "/"
                            })
                            console.log("Cookie: " + "lat:" + Cookies.get("umbrella_coord_lat") + " lng:" +
                                Cookies.get(
                                    "umbrella_coord_lng")); // debug

                            // variables with values from üç™s
                            cookie_lng = Cookies.get("umbrella_coord_lng");
                            cookie_lat = Cookies.get("umbrella_coord_lat");
                            // alert(liq_data.address.city); // debug
                            // alert(liq_location); // debug

                            weatherBallon(cookie_lat, cookie_lng); // pass coords to get weather info
                            airMask(cookie_lat, cookie_lng); // pass coords to get air quality info
                            // apsik(cookie_lat, cookie_lng); // pass coords to get allergy info; NOTE: API doesn't have good coverage
                        })

                }
            }
            // cookies set so we'll use that
            else {
                console.error("LocationIQ data not necessary - took data from üç™s.");

                console.log("Cookie: " + "lat:" + Cookies.get("umbrella_coord_lat") + " lng:" + Cookies.get(
                    "umbrella_coord_lng")); // debug

                // variables with values from üç™s
                cookie_lng = Cookies.get("umbrella_coord_lng");
                cookie_lat = Cookies.get("umbrella_coord_lat");
                cookie_location = Cookies.get("umbrella_location");

                if (cookie_location == "undefined") {
                    document.getElementById("location").textContent = "üåç ";
                } else {
                    document.getElementById("location").textContent = "üåç " + cookie_location;
                }

                weatherBallon(cookie_lat, cookie_lng); // pass coords to get weather info
                airMask(cookie_lat, cookie_lng); // pass coords to get air quality info
                // apsik(cookie_lat, cookie_lng); // pass coords to get allergy info; NOTE: API doesn't have good coverage}
            }

            if (!navigator.geolocation) {
                alert('Geolocation is not supported by your browser... :(');
            } else {
                navigator.geolocation.getCurrentPosition(success, error);
            }

        }

        function manualFinder() {
            query_input = prompt(
                "Where would you like to check the weather?"
            ); // if we don't know the location let's ask the user
            console.log("City:", query_input); // debug

            const liq_api_key = "a95509ae99d0ab"; // well... no way to hide it ¬Ø\_(„ÉÑ)_/¬Ø

            // grab data from URL
            fetch("https://eu1.locationiq.com/v1/search.php?key=" + liq_api_key + "&q=" + query_input +
                    "&format=json")

                // convert data to JSON
                .then(function (res) {
                    return res.json();
                })

                // use the data stored in object to do whatever
                .then(function (liq_data) {
                    console.error("LocationIQ",
                        liq_data); // debug: output everything stored in the object

                    // get location name based on what was returned from API and cut it to just city
                    liq_location = liq_data[0].display_name.split(",")[0];
                    // liq_location = liq_data.address.town;
                    // console.error(liq_location); // debug

                    document.getElementById("location").textContent = "üåç " + liq_location;

                    // set üç™ for location name
                    Cookies.set("umbrella_location", liq_location, {
                        expires: 30,
                        path: "/"
                    })

                    // get coords from API based on location user inputted 
                    lat = liq_data[0].lat;
                    lng = liq_data[0].lon;
                    console.log("Coords: " + lat + ", " + lng); // debug

                    // set üç™ for latitude
                    Cookies.set("umbrella_coord_lat", lat, {
                        expires: 30,
                        path: "/"
                    })
                    // set üç™ for longitude
                    Cookies.set("umbrella_coord_lng", lng, {
                        expires: 30,
                        path: "/"
                    })
                    console.log("Cookie: " + "lat:" + Cookies.get("umbrella_coord_lat") + " lng:" +
                        Cookies.get(
                            "umbrella_coord_lng")); // debug

                    // variables with values from üç™s
                    cookie_lng = Cookies.get("umbrella_coord_lng");
                    cookie_lat = Cookies.get("umbrella_coord_lat");

                    weatherBallon(cookie_lat, cookie_lng); // pass coords to get weather info
                    airMask(cookie_lat, cookie_lng); // pass coords to get air quality info
                    // apsik(cookie_lat, cookie_lng); // pass coords to get allergy info; NOTE: API doesn't have good coverage

                    location.reload();
                })
        }

        // find using GPS/IP when clicked on üìç
        function findMe() {
            function success(position) {
                const geo_latitude = position.coords.latitude;
                const geo_longitude = position.coords.longitude;

                // set üç™ for latitude
                Cookies.set("umbrella_coord_lat", geo_latitude, {
                    expires: 30,
                    path: "/"
                })
                // set üç™ for longitude
                Cookies.set("umbrella_coord_lng", geo_longitude, {
                    expires: 30,
                    path: "/"
                })
            }

            if (!navigator.geolocation) {
                alert('Geolocation is not supported by your browser... :(');
            } else {
                var locating = document.querySelector("#findme");
                locating.textContent = "Refresh the page :)";
                location.reload();
                navigator.geolocation.getCurrentPosition(success, error);
            }
        }

        document.querySelector('#location').addEventListener('click', manualFinder);
        document.querySelector('#findme').addEventListener('click', findMe);

        function smogAlert() {
            setTimeout(function () {
                var air_quality_status = document.getElementById("air_quality").textContent;
                if (air_quality_status == "Air quality: ‚ö∞Ô∏è") {
                    alert("Better not leave the building and do not open the windows! Smog kills ‚ò†Ô∏è");
                } else console.log("No alert, air is not so bad. Current: >", air_quality_status, "<");
            }, 1500); // how many ms to wait until function is executed
        }

        smogAlert();

    </script>

</body>

</html>