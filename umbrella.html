<!doctype html>
<html lang="en">

<head>

    <title>Umbrella</title>

    <meta property="og:title" content="Umbrella">
    <meta property="og:description" content="A simple weather page that tells you if you need to take an umbrella when going outside.">
    <meta property="og:image" content="https://i.ibb.co/zG08Mns/facebook-ogimage.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:url" content="https://vardecab.github.io/umbrella/umbrella.html">
    <meta name="twitter:card" content="summary_large_image">

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="icon" type="image/png" href="./images/umbrella.png" />

    <link rel="stylesheet" href="./styles/styles.css" />

    <script src="./scripts/weather.js"></script>
    <script src="./scripts/air_quality.js"></script>
    <!-- <script src="./scripts/allergy.js"></script> NOTE: API doesn't have good coverage -->

    <script src="./scripts/moment.min.js"></script> <!-- time formats manipulation -->
    <script src="./scripts/js.cookie.min.js"></script> <!-- lightweight JavaScript API for handling browser cookies -->

</head>

<body>
    <div class="container">
        <div class="row">
            <div class="twelve columns">

                <img id="icon" src="./images/loading.svg">

                <div id="temperature" title="Average temperature in the next 6 hours."></div>

                <div id="more_details">
                    <span id="sunrise">‚òÄÔ∏è </span>
                    <span id="wind">üçÉ </span>
                    <span id="sunset">üåí </span>
                </div>

                <div id="loading">Waiting for data...</div>

                <div id="umbrella" title="Rain?"></div>
                <div id="clothes" title="What should I wear? ü§î"></div>
                <div id="air_quality" title="ü§ì Good; ü§¢ Bad; ü§¨ Terrible; ‚ö∞Ô∏è RIP"></div>

            </div>
        </div>
    </div>

    <div id="bottom_navbar">
        <p id="location" onclick="Cookies.remove('umbrella_coord_lat'); location.reload();" title="Change the location!">üåç </p>    
    </div>

    <script>
        window.onload = function () {

            // if user doesn't have üç™s then we need to take location from API and save it for later
            if ((Cookies.get("umbrella_coord_lat") == undefined) || (Cookies.get("umbrella_coord_lng") ==
                    undefined)) {
                query_input = prompt(
                    "Dla jakiego miasta chcesz sprawdziƒá pogodƒô?"
                ); // if we don't know the location let's ask the user
                console.log("City:", query_input); // debug

                const liq_api_key = "a95509ae99d0ab";

                // grab data from URL
                fetch("https://eu1.locationiq.com/v1/search.php?key=" + liq_api_key + "&q=" + query_input +
                        "&format=json")

                    // convert data to JSON
                    .then(function (res) {
                        return res.json();
                    })

                    // use the data stored in object to do whatever
                    .then(function (data) {
                        console.error("LocationIQ", data); // debug: output everything stored in the object

                        // get location name based on what was returned from API and cut it to just city
                        liq_location = data[0].display_name.split(",")[0];
                        // console.error(liq_location); // debug

                        document.getElementById("location").textContent += liq_location;

                        // set üç™ for location name
                        Cookies.set("umbrella_location", liq_location, {
                            expires: 30,
                            path: "/"
                        })

                        // get coords from API based on location user inputted 
                        lat = data[0].lat;
                        lng = data[0].lon;
                        console.log("Coords: " + lat + ", " + lng); // debug

                        // set üç™ for latitude
                        Cookies.set("umbrella_coord_lat", lat, {
                            expires: 30,
                            path: "/"
                        })
                        // set üç™ for longitude
                        Cookies.set("umbrella_coord_lng", lng, {
                            expires: 30,
                            path: "/"
                        })
                        console.log("Cookie: " + "lat:" + Cookies.get("umbrella_coord_lat") + " lng:" +
                            Cookies.get(
                                "umbrella_coord_lng")); // debug

                        // variables with values from üç™s
                        cookie_lng = Cookies.get("umbrella_coord_lng");
                        cookie_lat = Cookies.get("umbrella_coord_lat");

                        weatherBallon(cookie_lat, cookie_lng); // pass coords to get weather info
                        airMask(cookie_lat, cookie_lng); // pass coords to get air quality info
                        // apsik(cookie_lat, cookie_lng); // pass coords to get allergy info; NOTE: API doesn't have good coverage
                    })
            }
            // looks like üç™s are ready - let's use them
            else {
                console.error("LocationIQ data not necessary - took data from üç™s.");

                console.log("Cookie: " + "lat:" + Cookies.get("umbrella_coord_lat") + " lng:" + Cookies.get(
                    "umbrella_coord_lng")); // debug

                // variables with values from üç™s
                cookie_lng = Cookies.get("umbrella_coord_lng");
                cookie_lat = Cookies.get("umbrella_coord_lat");
                cookie_location = Cookies.get("umbrella_location");

                document.getElementById("location").textContent += cookie_location;

                weatherBallon(cookie_lat, cookie_lng); // pass coords to get weather info
                airMask(cookie_lat, cookie_lng); // pass coords to get air quality info
                // apsik(cookie_lat, cookie_lng); // pass coords to get allergy info; NOTE: API doesn't have good coverage
            }

        }

        // if ("serviceWorker" in navigator) {
        //     navigator.serviceWorker
        //         .register("service_worker.js")
        //         .then(function () {
        //             console.log("Service Worker registered successfully :]");
        //         });
        // }
    </script>

</body>

</html>